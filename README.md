# Host and Embedded Hardware Tests

Copyright (c) 2023 Djones A. Boni - MIT License

This is a proof of concept (and a starting point) to
build and test an Embedded C project on:

1. The host machine (the programmer's computer); and on
2. The embedded hardware (AVR ATmega2560 in this example).

We use [Unity](https://github.com/ThrowTheSwitch/Unity) as the C test framework.

[Zig](https://ziglang.org/) serves as a multi-platform build tool for
the host architecture, C compiler and test runner generator.

For the embedded hardware we use `avr-gcc` and `make` for building,
`avrdude` to flash the microcontrollers and
`qemu-system-avr` for simulations.

Since the Unity test framework uses only the C language, it is not able to
automatically register the tests cases.
To overcome that, we automatically generate the test runners based on the
test files right before building the tests.
Unity already comes with a Ruby script that does a similar job automating
that process, however in this project we do that with Zig to have one less
dependency.

## Adding Files to the Project

In the `build.zig` file there are three main variables that hold the
paths to the source code:

- `production_exe_files`: Production files that link only to the executable
  (these are not tested);
- `production_lib_files`: Production files that link to both the executable
  and to the tests; and
- `test_files`: Test files, from which the test runners are generated, and
  only link to the tests.

Additionally, you might need to add more include paths using
`addIncludePath()`.

In a similar manner, the `Makefile` file has three main variables that
hold the paths to the source code:

- `PROD_EXE_SOURCES`: Production files that link only to the executable
  (these are not tested);
- `PROD_LIB_SOURCES`: Production files that link to both the executable
  and to the tests; and
- `TEST_LIB_SOURCES`: Test files that only link to the tests (the Makefile
  does not trigger the test runner generation, so the test runners must
  already be generated by running the tests with Zig).

Additionally, you might need to add more include paths using the variable:

- `PROD_INCLUDE_DIRS`: Paths to the included files (add `-I` before the path).

And there are these three additional variables, which are useful to set
to force the rebuild in case of a change in the header files:

- `PROD_EXE_HEADERS`: Production headers used only in the executable;
- `PROD_LIB_HEADERS`: Production headers used in both the executable
  and in the tests; and
- `TEST_LIB_HEADERS`: Test headers used only in the tests.

## Build and Run the Tests

Test in the host machine using Zig (test runner generation is automatic):

```sh
zig build test
```

Test simulating the embedded hardware using Qemu:

```sh
make test_sim
```

Test in the embedded hardware:

```sh
make test_flash SERIAL=/dev/ttyACM0
```

## Build and Run the Project Executable

Run in the host machine using Zig:

```sh
zig build run -- 1 2
```

Run simulating the embedded hardware using Qemu
(use `Ctrl+A (release) + X` to quit from Qemu):

```sh
make prod_sim
```

Run in the embedded hardware:

```sh
make prod_flash SERIAL=/dev/ttyACM0
```
